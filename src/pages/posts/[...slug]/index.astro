---
import Layout from '@/layouts/Layout.astro';
import { render, getCollection, type CollectionEntry } from 'astro:content';
import { formatDate } from '@/lib/utils/date';
import TableOfContents from '@/components/TableOfContents.svelte';

import Breadcrumbs from '@/components/Breadcrumbs.svelte';
import SocialShare from '@/components/SocialShare.svelte';
import { getBlogPostingSchema, getBreadcrumbSchema } from '@/lib/schemas';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post: CollectionEntry<'posts'>) => ({
    params: { slug: post.id },
    props: post,
  }));
}

type Props = CollectionEntry<'posts'>;

const post = Astro.props as Props;
const { Content, headings } = await render(post);

const schemas = [
  getBlogPostingSchema({
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate,
    url: new URL(Astro.url.pathname, Astro.site).toString(),
    image: new URL(`/og/${post.id}.png`, Astro.site).toString(),
    tags: post.data.tags,
  }),
  getBreadcrumbSchema([
    { name: 'Blog', url: new URL('/posts', Astro.site).toString() },
    { name: post.data.title, url: new URL(Astro.url.pathname, Astro.site).toString() },
  ]),
];
---

<Layout
  title={post.data.title}
  description={post.data.description}
  ogImage={`/og/${post.id}.png`}
  schema={schemas}
>
  <Breadcrumbs
    items={[
      { name: 'Blog', href: '/posts' },
      { name: post.data.title, href: '#' },
    ]}
  />

  <div class="lg:flex lg:gap-16">
    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <div class="mb-8">
        <header class="flex flex-col gap-4">
          <div
            class="flex items-center gap-3 text-xs text-muted-foreground font-bold uppercase tracking-widest"
          >
            <time datetime={post.data.pubDate.toISOString()}>
              {formatDate(post.data.pubDate)}
            </time>
            {
              post.data.tags && post.data.tags.length > 0 && (
                <>
                  <span class="text-border">â€¢</span>
                  <div class="flex gap-2 text-[10px] uppercase font-bold tracking-widest text-muted-foreground/60">
                    {post.data.tags.map((tag: string) => (
                      <span class="opacity-70">#{tag}</span>
                    ))}
                  </div>
                </>
              )
            }
          </div>

          <h1 class="text-4xl font-black tracking-tight text-foreground sm:text-5xl">
            {post.data.title}
          </h1>

          <p class="text-lg text-muted-foreground italic border-l-2 border-primary/20 pl-4 py-1">
            {post.data.description}
          </p>
        </header>
      </div>

      <article class="prose max-w-none mt-12 mb-16">
        <Content />
      </article>

      <SocialShare client:load title={post.data.title} urlPath={Astro.url.pathname} />
    </div>

    <!-- Sidebar (TOC) -->
    <div class="hidden lg:block w-64 flex-shrink-0">
      <TableOfContents client:load {headings} />
    </div>
  </div>
</Layout>
