---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import Layout from '@/layouts/Layout.astro';
import PostCard from '@/components/PostCard.svelte';

export const getStaticPaths = (async () => {
  const posts = await getCollection('posts');
  const allTags = Array.from(new Set(posts.flatMap((post) => post.data.tags || [])));

  return allTags.map((tag) => {
    const filteredPosts = posts
      .filter((post) => post.data.tags?.includes(tag))
      .sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

    return {
      params: { tag },
      props: { tag, posts: filteredPosts },
    };
  });
}) satisfies GetStaticPaths;

const { tag, posts } = Astro.props;
---

<Layout title={`Posts tagged with "${tag}"`} description={`Blog posts tagged with ${tag}`}>
  <div class="mb-12">
    <a
      href="/posts"
      class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-orange-500 transition-colors group mb-8"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="mr-2 h-4 w-4 transition-transform group-hover:-translate-x-1"
        viewBox="0 0 20 20"
        fill="currentColor"
      >
        <path
          fill-rule="evenodd"
          d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
          clip-rule="evenodd"></path>
      </svg>
      All posts
    </a>

    <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 dark:text-gray-100 sm:text-5xl">
      Topic: <span class="text-orange-500">#{tag}</span>
    </h1>
    <p class="mt-4 text-base text-gray-600 dark:text-gray-400">
      {`A collection of ${posts.length} ${posts.length === 1 ? 'post' : 'posts'} about ${tag}.`}
    </p>
  </div>

  <div class="flex flex-col">
    {posts.map((post) => <PostCard post={post} />)}
  </div>
</Layout>
